/*  臺北市立大安高工資訊科程式設計實習課程之作業展示成績統計工具
  ┌──────────────────┐
  │ created by Hans  │
  │        2016/04/02│
  └──────────────────┘
       
  ┌────────────────────────────────────────────┐
  │請複製以下短碼於作業展示網頁以F12開啟Console並貼上
  ├──────────────────────────────────────────┤
  
       
*/
var ls={};ls.pRound=function(t,e){for(var r=0;e>r;r++)t*=10;t=Math.round(t);for(var r=0;e>r;r++)t/=10;return t},ls.genTrNodes=function(t,e){var r=document.createElement("tr");for(var s in e){var n=document.createElement(t);n.textContent=e[s],r.appendChild(n)}return r},ls.gfForSortTable=function(t,e){var r=t.parentElement.parentElement.parentElement.getElementsByTagName("tbody")[0];return function(){var t=r.getElementsByTagName("tr"),s=[];for(var n in t)t[n]instanceof Node&&s.push(t[n]);s.sort(function(t,r){return Number(t.getElementsByTagName("td")[e].textContent)-Number(r.getElementsByTagName("td")[e].textContent)}),r.childNodes=[];for(var n in s)r.appendChild(s[n])}},ls.genTable=function(t,e,r){var s=document.createElement("table");s.setAttribute("class","table table-bordered table-hover"),s.setAttribute("style","background:#ffffff");var n=document.createElement("thead"),a=document.createElement("tbody");n.appendChild(ls.genTrNodes("th",t));for(var o in e){var i=ls.genTrNodes("td",e[o]);i.setAttribute("title",r[o].getTitles()),a.appendChild(i)}var c=n.getElementsByTagName("th");for(var o in c){var l=c[o];l instanceof Node&&l.setAttribute("onclick","ls.gfForSortTable(this, "+o+")()")}return s.appendChild(n),s.appendChild(a),s},ls.score=function(t,e,r,s,n){this.name=t.trim(),this.stats=e,this.score=r,this.title=s.trim(),this.time=n.trim()},ls.getSubString=function(t,e){var r=[];for(var s in e){var n=e[s],a=n.length,o=t.search(n);r.push({start:o,end:o+a})}var i=[];for(var s in r){var c=r[s].end,l=t.length;if(-1==r[s].start)i.push({stats:0,text:""});else{for(var u in r){var m=r[u].start;m>c&&l>m&&(l=m)}i.push({stats:1,text:t.slice(c,l)})}}return i},ls.getScoreByString=function(t){if(null==t)return new ls.score("","noScore",0,"","");var e=0;t="thisname:"+t.substr(e);var r=ls.getSubString(t,["thisname:","得分：","評語：","時間："]);return 1==r[1].stats?new ls.score(r[0].text,"scored",Number(r[1].text),r[2].text,r[3].text):new ls.score(r[0].text,"noScore",0,"","")},ls.student=function(t,e){this.name=t.trim(),this.number=e,this.scores=[],this.sum=0,this.ava=0,this.rank=0,this.titles=[],this.calcScore=function(){if(!(this.scores.length<=0)){var t=0,e=0;this.titles=[];for(var r in this.scores)if("scored"==this.scores[r].stats){t+=Number(this.scores[r].score),e++;var s=this.scores[r].title;"(無)"!=s&&this.titles.push({name:this.scores[r].name,text:s})}this.sum=t,0!=e?this.ava=t/e:this.ava=0}},this.toString=function(){return this.number+"	"+this.name+"	"+this.sum+"	"+ls.pRound(this.ava,0)+"	"+this.rank},this.getTitles=function(){var t="";for(var e in this.titles)t+=this.titles[e].name+"	"+this.titles[e].text+"\n";return t}},ls.getData=function(){var t=[],e=document.getElementsByTagName("tbody")[1],r=e.getElementsByTagName("tr");for(var s in r){var n=r[s];if(n instanceof Node){for(var a=n.getElementsByTagName("td"),o=new ls.student(a[1].textContent,Number(a[0].textContent)),i=2;i<a.length;i++)o.scores.push(ls.getScoreByString(a[i].getAttribute("title")));o.calcScore(),t.push(o)}}return t},ls.calcRank=function(t){var e=[];for(var r in t)e.push({id:r,data:t[r]});e.sort(function(t,e){return-t.data.ava+e.data.ava});for(var r in e)t[e[r].id].rank=Number(r)+1},ls.genStudentTable=function(t){var e=[];for(var r in t){var s=t[r];e.push([s.number,s.name,s.rank,s.sum,ls.pRound(s.ava,2)])}return ls.genTable(["座號","姓名","名次","總分","平均"],e,t)},ls.dothework=function(){var t=ls.getData();ls.calcRank(t);var e=document.getElementsByTagName("body")[0];e.innerHTML+="<script src='https://code.jquery.com/jquery-1.12.0.min.js'></script><script src='https://code.jquery.com/jquery-migrate-1.2.1.min.js'></script><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css' ><link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css'><script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js'></script>";var r=document.createElement("div");r.setAttribute("class","container");var s=document.createElement("div");s.setAttribute("class","col-md-12 panel-body");var n=ls.genStudentTable(t);s.appendChild(n),r.appendChild(s),e.appendChild(r),console.log("%c 計算完成! 結果請見網頁下方表格\n%c  點擊表格標籤可以選擇排序目標 ","color:#0080ff","color:#000000")},ls.dothework();